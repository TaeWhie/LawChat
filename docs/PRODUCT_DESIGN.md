# 노동법 RAG 챗봇 — 기획 문서

> 대상 독자: 프로덕트 매니저, 서비스 기획자, 백엔드/프론트엔드 개발자, QA 엔지니어

---

## 1. 서비스 개요

### 1.1 목적

한국의 11개 노동관련 법령 데이터에만 기반하여, 일반 근로자가 직장에서 겪는 법적 문제를 자연어로 상담할 수 있는 AI 챗봇을 제공한다. 모든 답변은 **법령 조문 인용 근거**를 포함하며, RAG(Retrieval-Augmented Generation)로 할루시네이션을 최소화한다.

### 1.2 핵심 설계 원칙

| 원칙 | 설명 |
|------|------|
| **법령 근거 중심** | 법령 데이터에 없는 내용은 "해당 내용은 제공된 법령 데이터에 없습니다."로만 답변 |
| **진단적 상담 흐름** | 단순 Q&A가 아닌, 체크리스트 기반 진단 → 맞춤형 결론 |
| **비용 최적화** | `gpt-5-nano` + `reasoning_effort=low` + 스트리밍으로 빠른 응답 |
| **투명성** | 모든 인용 조문 번호 명시, AI 답변 참고용 면책 고지 |

### 1.3 지원 법률 범위 (11개 법령)

```
개별적 근로관계법
├── 근로기준법 (법률·시행령·시행규칙)
├── 최저임금법
├── 근로자퇴직급여 보장법
├── 남녀고용평등과 일·가정 양립 지원에 관한 법률
└── 기간제 및 단시간근로자 보호 등에 관한 법률

집단적 노사관계법
├── 노동조합 및 노동관계조정법
└── 근로자참여 및 협력증진에 관한 법률

노동시장 및 협력적 법률
├── 산업안전보건법
├── 고용보험법
├── 직업안정법
└── 산업재해보상보험법
```

---

## 2. 사용자 플로우

### 2.1 전체 플로우 다이어그램

```
사용자 입력 (자연어 상황 설명)
         │
         ▼
   [이슈 분류 Step1]
   키워드 매칭 (빠른 경로)
   또는 LLM 분류 (느린 경로)
   → 이슈 확정 (예: 퇴직금, 해고, 최저임금 등)
         │
         ▼
   [체크리스트 Step2]
   이슈 관련 조문 검색 (RAG)
   → 예/아니요/모르겠음 질문 생성 (최대 7개)
         │
         ▼
   [사용자 답변]
   체크리스트에 대해 네/아니요/모르겠음 선택
   (최대 3차 라운드 반복 가능)
         │
         ▼
   [결론 생성 Step3]
   Q&A + 관련 조문 → 스트리밍 결론 생성
   법령 조문 번호 인용 포함
         │
         ▼
   [연관 질문 제안]
   결론 기반 3~5개 후속 질문 제안
         │
         ▼
   사용자 클릭 시 → 새 이슈 분류 사이클 시작
```

### 2.2 화면별 UX

#### 2.2.1 초기 빈 화면 (Welcome Screen)

- 서비스 제목 및 간단 설명
- 예시 질문 버튼 6개 (즉시 클릭 가능)
  - "월급을 제때 못 받았어요"
  - "갑자기 해고 통보를 받았어요"
  - "연장근무 수당을 못 받았어요"
  - "육아휴직을 거부당했어요"
  - "최저임금보다 적게 받고 있어요"
  - "부당한 징계를 받았어요"
- 데이터 출처 및 AI 면책 고지

#### 2.2.2 채팅 화면 (Chat UI)

- Streamlit `@st.fragment`로 채팅 영역만 부분 리런 (사이드바/헤더 리로드 없음)
- 사용자/어시스턴트 메시지 말풍선
- 어시스턴트 말풍선 하단에 체크리스트 UI 삽입 (마지막 메시지에만)
- 체크리스트 진행 상태 표시: `진행 중 (2/6)`
- 처리 중 스피너 4단계 메시지 순환:
  1. "🔍 상황을 분석하고 관련 법령을 검색하고 있습니다..."
  2. "📋 이슈를 분류하고 체크리스트를 생성하고 있습니다..."
  3. "⚖️ 법령 조문을 검토하고 결론을 작성하고 있습니다..."
  4. "✍️ 답변을 정리하고 있습니다..."

#### 2.2.3 체크리스트 UI

- 각 질문당 **네 / 아니요 / 모르겠음** 3개 버튼
- 현재 답변 선택 시 해당 버튼 `primary` (파란색) 스타일
- 모든 질문 답변 완료 시 **"다음 →"** 버튼 활성화
- 미완료 시 `"다음 (2/6 완료)"` 형태로 진행률 표시
- 제출 후 결론 생성 시작 (스트리밍)

#### 2.2.4 결론 화면

- 스트리밍으로 실시간 표시 (`st.write_stream`)
- 결론 하단 "📎 함께 확인해 보세요: 제9조, 제10조 ..." 조문 힌트
- 결론 생성 후 "💡 이런 것도 궁금하지 않으신가요?" 연관질문 버튼 3개 표시

#### 2.2.5 사이드바 — 법률 둘러보기

- **처리 중 알림 배너**: AI 처리 중에도 사이드바에서 법률 탐색 가능
  - "⏳ 답변을 생성하고 있습니다... 법률을 자유롭게 둘러보세요."
  - 답변 완료 시 "← 채팅으로 돌아가기 🔔" 강조 표시
- 법령 트리: 법령 그룹 > 개별 법령 > 장(Chapter) > 조문(Article)
- 조문 클릭 시 상세 보기 전환 (`scope="app"` 전체 리런)
- 조문 상세: 조번호, 조명, 항/호/목 구조별 스타일 렌더링
- "← 채팅으로" 버튼으로 복귀
- 답변 대기 중 법률 탐색 후 복귀 시 완성된 답변 자동 반영

#### 2.2.6 새 대화 시작

- 사이드바 상단 "🔄 새 대화 시작" 버튼
- 확인 다이얼로그: "✅ 새 대화 시작" / "❌ 취소" (기존 대화 실수 삭제 방지)
- 클릭 시 모든 세션 상태 초기화 (메시지, 체크리스트, 이슈 등)

---

## 3. 상담 가능 이슈 분류

| 이슈 카테고리 | 관련 법령 |
|---------------|-----------|
| 임금 미지급/체불 | 근로기준법 |
| 퇴직금 | 근로자퇴직급여 보장법, 근로기준법 |
| 해고/징계 | 근로기준법 |
| 최저임금 | 최저임금법, 근로기준법 |
| 근로시간/연장수당 | 근로기준법 |
| 휴일/연차휴가 | 근로기준법 |
| 육아휴직/출산휴가 | 남녀고용평등법, 근로기준법 |
| 기간제/단시간 | 기간제법, 근로기준법 |
| 직장 내 괴롭힘 | 근로기준법 |
| 산업안전/산재 | 산업안전보건법, 산재보험법 |
| 고용보험 | 고용보험법 |
| 노동조합 | 노동조합법, 근로자참여법 |

---

## 4. 데이터 흐름

### 4.1 법령 데이터 수집·저장

```
국가법령정보 공동활용 API (OC 인증 필요)
         │
         ▼ scripts/sync_all.py (주 1회 자동 실행, GitHub Actions)
   api_data/
   ├── laws/          # 법령 본문 JSON
   ├── terms/         # 법령 용어 정의
   ├── bylaws/        # 시행령·시행규칙
   ├── related/       # 연관 법령 정보
   └── precedents/    # 판례 요약
         │
         ▼ build_vector_store()  (최초 1회 또는 rebuild 시)
   vector_store/      # ChromaDB 임베딩 DB
   (text-embedding-3-large, 3072차원)
```

### 4.2 상담 요청 데이터 흐름

```
사용자 입력 → graph.invoke()
         │
         ▼
[LangGraph State Machine]
state = {
  messages, phase, situation,
  issues, selected_issue, articles_by_issue,
  checklist, qa_list,
  checklist_rag_results, pending_question
}
         │
         ├─[phase="input"]→ step1 + step2 병렬 실행
         ├─[phase="checklist"]→ step2 (추가 라운드) 또는 step3
         └─[phase="conclusion"]→ 새 상담 시작
```

---

## 5. 성능 지표 (퇴직금 시나리오 기준)

| 단계 | 이전 (v1.0) | 현재 (v2.0) | 개선율 |
|------|-------------|-------------|--------|
| 벡터스토어 로딩 | 2~4초 (매회) | ~1.3초 (캐싱) | ≈70% 단축 |
| Step1+2 (이슈+체크리스트) | 35초 | 7~12초 | ≈77% 단축 |
| Step3 첫 토큰 출력 | 55초 | 10초 | ≈82% 단축 |
| Step3 결론 완료 | 55초 | 17~20초 | ≈68% 단축 |
| **전체 응답 시간** | **91초** | **25~35초** | **≈72% 단축** |

### 5.1 주요 최적화 기법

1. **`reasoning_effort=low`**: gpt-5-nano reasoning 토큰 대폭 감소 → 속도 3~6배 향상
2. **Step1+2 병렬 실행**: 키워드 경로 시 조문 수집과 체크리스트 생성 동시 진행
3. **`@st.cache_resource`**: 그래프·벡터스토어 프로세스당 1회만 초기화
4. **`@st.fragment`**: 채팅 영역만 부분 리런 (사이드바·헤더 재렌더링 제거)
5. **LRU 캐시 500개**: 동일 쿼리 임베딩 재사용
6. **스트리밍 결론**: `st.write_stream`으로 첫 토큰부터 즉시 표시

---

## 6. 오류 처리 정책

| 오류 유형 | 처리 방식 |
|-----------|-----------|
| LLM API 오류 | "일시적인 오류가 발생했습니다. 잠시 후 다시 시도해 주세요." |
| 그래프 로드 실패 | 상단 경고 + 기존 히스토리 표시 유지 |
| 벡터스토어 없음 | USER_FACING_ERROR 메시지 표시 |
| 오프토픽 질문 | 노동법 범위 외임을 안내하고 예시 제시 |
| 임베딩 API 오류 | store.py에서 공식 OpenAI 엔드포인트 강제 사용 (프록시 우회) |

---

## 7. 배포 환경 설정

### 7.1 필수 환경 변수

| 변수명 | 설명 | 필수 여부 |
|--------|------|-----------|
| `OPENAI_API_KEY` | OpenAI API 키 (LLM + 임베딩) | **필수** |
| `LAW_API_OC` | 국가법령정보 API 인증 코드 | 법령 동기화 시 필수 |
| `LAW_CHAT_MODEL` | LLM 모델명 (기본: gpt-5-nano) | 선택 |
| `LAW_EMBEDDING_MODEL` | 임베딩 모델 (기본: text-embedding-3-large) | 선택 |

### 7.2 주의사항

- `OPENAI_BASE_URL` **설정 금지**: 임베딩 API가 프록시를 통하면 404 오류 발생
  - LLM 프록시(Genspark 등) 사용 시에도 임베딩은 반드시 공식 엔드포인트 사용
  - `rag/store.py`에서 임베딩 클라이언트에 `https://api.openai.com/v1` 강제 지정
- Streamlit Cloud: `st.secrets`에 환경변수 설정 → `config.py`가 자동 주입

### 7.3 데이터 초기화 순서

```bash
# 1. 법령 데이터 동기화 (최초 또는 갱신 시)
python scripts/sync_all.py

# 2. 벡터스토어 재구축 (동기화 후 반드시 실행)
python main.py --rebuild

# 3. 앱 실행
streamlit run app_chatbot.py
```

---

## 8. GitHub Actions 자동화

- **스케줄**: 매주 월요일 02:00 UTC (한국 오전 11시)
- **동작**: 법령 동기화 → 임베딩 재구축 → 변경 데이터 자동 커밋
- **Secrets 설정 필요**: `OPENAI_API_KEY`, `LAW_API_OC`

---

## 9. 앱 구분

| 파일 | 용도 | 대상 |
|------|------|------|
| `app_chatbot.py` | **서비스용** 대화형 챗봇 | 일반 사용자 |
| `app.py` | 개발/기획자용 4단계 상세 UI | 내부 검증, 기획자 |

`app.py`는 이슈 분류 결과, 체크리스트 생성 과정, 조문 검색 상세 등을 단계별로 시각화하여 파이프라인 검증에 사용한다.

---

## 10. 제약사항 및 한계

1. **법령 데이터 범위**: 상기 11개 법령 외 법령(민법, 형법 등)은 지원하지 않음
2. **개인별 상황 판단**: AI 답변은 법적 조언이 아닌 참고용. 전문가 상담 권장
3. **최신성**: GitHub Actions 주간 자동 동기화. 법령 개정 후 반영까지 최대 7일 지연 가능
4. **비용**: 상담 1회당 임베딩(검색) + LLM(체크리스트+결론) API 호출. OpenAI API 비용 발생
5. **다국어**: 한국어만 지원
