# -*- coding: utf-8 -*-
"""
노동법 핵심 키워드 (근로계약·시간·임금 중심).

이슈 분류, API 동기화(판례/해석례 키워드 검색), 쿼리 확장 시 참조.
문서: docs/LABOR_LAW_KEYWORDS.md
"""
import re as _re
from typing import Tuple

# -----------------------------------------------------------------------------
# 이슈 정규화: 상담에서 쓰는 "정규화된 이슈(primary)" 목록과 일상 표현 매핑
# docs/LABOR_LAW_KEYWORDS.md 1~6장 구조와 맞춤. LLM 이슈 분류·허용 목록에 사용.
# -----------------------------------------------------------------------------

# 정규화된 이슈 이름 목록 (허용 primary). 순서 유지.
# 여러 노동법을 포괄하는 이슈 포함
PRIMARY_ISSUES = (
    "임금",
    "퇴직금",
    "해고/징계",
    "근로계약",
    "휴일/휴가",
    "근로시간",
    "직장 내 괴롭힘",
    "근로자 보호",
    "산재",  # 산업재해보상보험법
    "산업안전",  # 산업안전보건법
    "노조",  # 노동조합 및 노동관계조정법
    "최저임금",  # 최저임금법
    "남녀고용평등",  # 남녀고용평등법
    "육아휴직",  # 남녀고용평등법
    "고용보험",  # 고용보험법
)

# 일상 표현·동의어 → 정규화된 이슈(primary) 매핑. 정규화·쿼리 확장 시 사용.
# 키가 길수록 구체적이므로 normalize 시 긴 키부터 매칭하는 쪽이 좋음.
ISSUE_SYNONYMS = {
    # 임금
    "월급": "임금",
    "급여": "임금",
    "연봉": "임금",
    "체불": "임금",
    "임금체불": "임금",
    "통상임금": "임금",
    "평균임금": "임금",
    "최저임금": "임금",
    "휴업수당": "임금",
    "지연이자": "임금",
    "돈": "임금",  # 문맥에 따라 퇴직금도 가능하나 기본은 임금
    # 퇴직금
    "퇴직연금": "퇴직금",
    "금전보상": "퇴직금",
    "금전보상제": "퇴직금",
    "퇴사": "퇴직금",
    "퇴직": "퇴직금",
    # 해고/징계
    "해고": "해고/징계",
    "나오지 말래요": "해고/징계",
    "나오지 마세요": "해고/징계",
    "나오지 말라": "해고/징계",
    "부당해고": "해고/징계",
    "정리해고": "해고/징계",
    "해고예고": "해고/징계",
    "해고 예고": "해고/징계",
    "징계": "해고/징계",
    "권고사직": "해고/징계",
    "의원면직": "해고/징계",
    "계약해지": "해고/징계",
    # 휴일/휴가
    "휴가": "휴일/휴가",
    "연차": "휴일/휴가",
    "연차휴가": "휴일/휴가",
    "주휴일": "휴일/휴가",
    "연차 유급휴가": "휴일/휴가",
    "대체공휴일": "휴일/휴가",
    "미사용 연차": "휴일/휴가",
    # 근로시간
    "야근": "근로시간",
    "연장근로": "근로시간",
    "주 52시간": "근로시간",
    "52시간": "근로시간",
    "가산수당": "근로시간",
    "휴게시간": "근로시간",
    "탄력근로": "근로시간",
    # 근로계약
    "근로계약서": "근로계약",
    "취업규칙": "근로계약",
    "단체협약": "근로계약",
    "시용": "근로계약",
    "기간제": "근로계약",
    "파견": "근로계약",
    # 직장 내 괴롭힘
    "괴롭힘": "직장 내 괴롭힘",
    "성희롱": "직장 내 괴롭힘",
    # 산재
    "산재": "산재",
    "산업재해": "산재",
    "업무상재해": "산재",
    "업무상재해보상": "산재",
    "산재보험": "산재",
    # 산업안전
    "산업안전": "산업안전",
    "작업중지": "산업안전",
    "작업중지권": "산업안전",
    "안전보건": "산업안전",
    "위험": "산업안전",
    "작업 거부": "산업안전",
    "작업거부": "산업안전",
    # 노조
    "노조": "노조",
    "노동조합": "노조",
    "부당노동행위": "노조",
    "단체교섭": "노조",
    # 최저임금
    "최저임금": "최저임금",
    "수습기간": "최저임금",
    "수습": "최저임금",
    "수습사원": "최저임금",
    # 남녀고용평등
    "남녀고용평등": "남녀고용평등",
    "육아휴직": "육아휴직",
    "성차별": "남녀고용평등",
    # 고용보험
    "고용보험": "고용보험",
    "실업급여": "고용보험",
    "직장 내 성희롱": "직장 내 괴롭힘",
    # 근로자 보호 (감봉, 명부, 재해 등)
    "감봉": "근로자 보호",
    "산업재해": "근로자 보호",
    "중대재해": "근로자 보호",
}

# -----------------------------------------------------------------------------
# API 동기화·검색용 키워드
# -----------------------------------------------------------------------------

# 카테고리별 대표 검색어 (API 검색·동기화용으로 짧은 키워드 위주)
LABOR_KEYWORDS_BY_CATEGORY = {
    "근로계약": [
        "근로계약서",
        "취업규칙",
        "단체협약",
        "시용",
        "채용내정",
        "수습근로자",
        "위약 예정",
        "전차금 상계",
        "경업금지",
        "사이닝 보너스",
        "기간제 근로자",
        "단시간 근로자",
        "파견 근로",
        "사내도급",
        "근로자파견",
    ],
    "근로시간": [
        "법정근로시간",
        "주 52시간",
        "연장근로",
        "야간근로",
        "휴일근로",
        "가산수당",
        "휴게시간",
        "탄력적 근로시간제",
        "선택적 근로시간제",
        "재량근로",
    ],
    "임금": [
        "통상임금",
        "평균임금",
        "최저임금",
        "휴업수당",
        "임금체불",
        "지연이자",
        "포괄임금제",
        "임금피크제",
    ],
    "휴게_휴일_휴가": [
        "주휴일",
        "연차 유급휴가",
        "대체공휴일",
        "미사용 연차 수당",
    ],
    "해고_계약종료": [
        "해고 예고",
        "정리해고",
        "부당해고",
        "퇴직금",
        "퇴직연금",
        "금전보상제",
    ],
    "기타": [
        "직장 내 괴롭힘",
        "직장 내 성희롱",
        "감봉",
        "산업재해",
        "중대재해처벌법",
    ],
}

# 평면 리스트 (전체 키워드 한 번에 사용 시)
LABOR_KEYWORDS_FLAT = [
    kw
    for kws in LABOR_KEYWORDS_BY_CATEGORY.values()
    for kw in kws
]

# API 검색 시 자주 쓰는 소량 키워드 (동기화 부하 절감용)
LABOR_KEYWORDS_SEARCH = [
    "퇴직금",
    "해고",
    "임금",
    "근로기준법",
    "부당해고",
    "정리해고",
    "연차휴가",
    "근로계약",
    "최저임금",
]

# sync_terms 전용: 용어·연계 API(lstrmAI, dlytrm, lstrmRlt, dlytrmRlt) 동기화에 쓸 키워드.
# PRIMARY_ISSUES·법률별 대표어 포함해 캐시 커버리지 확대.
TERM_SYNC_KEYWORDS = [
    # 기존 검색용
    "퇴직금",
    "해고",
    "임금",
    "근로기준법",
    "부당해고",
    "정리해고",
    "연차휴가",
    "근로계약",
    "최저임금",
    # 임금·근로시간
    "평균임금",
    "통상임금",
    "연장근로",
    "휴업수당",
    "포괄임금제",
    # 휴가·휴일
    "연차",
    "주휴일",
    # 산재·산업안전·노조·고용보험·남녀고용평등
    "산재",
    "산업재해",
    "산업안전",
    "노동조합",
    "고용보험",
    "육아휴직",
    "남녀고용평등",
    # 기타
    "직장 내 괴롭힘",
]


# ---------------------------------------------------------------------------
# 빠른 off-topic 감지 (LLM 불필요, 키워드 기반)
# ---------------------------------------------------------------------------

# 노동법 관련 핵심 키워드 집합 (포함 시 노동법 관련으로 판단)
_LABOR_POS_KEYWORDS: frozenset = frozenset([
    # 임금·급여
    "임금", "월급", "급여", "연봉", "통상임금", "평균임금", "체불", "임금체불",
    "수당", "상여금", "성과급", "포괄임금", "최저임금", "시급", "일당",
    # 퇴직
    "퇴직금", "퇴직", "퇴사", "퇴직연금", "중간정산",
    # 해고·징계
    "해고", "부당해고", "정리해고", "권고사직", "해고예고", "징계",
    "해임", "면직", "계약해지", "비자발적", "강제퇴직",
    # 근로계약
    "근로계약", "근로계약서", "계약서", "취업규칙", "단체협약",
    "기간제", "파견", "도급", "수습", "시용", "수습기간",
    # 근로시간·휴식
    "근로시간", "야근", "연장근로", "초과근무", "주52시간", "52시간",
    "가산수당", "휴게시간", "탄력근로",
    # 휴일·휴가
    "연차", "연차휴가", "유급휴가", "휴가", "주휴일", "공휴일",
    "생리휴가", "병가", "육아휴직", "출산휴가", "배우자출산휴가",
    # 직장 내 문제
    "괴롭힘", "직장내괴롭힘", "직장 내 괴롭힘", "성희롱", "차별",
    # 산재·안전
    "산재", "산업재해", "업무상재해", "산재보험", "산업안전", "작업중지",
    "안전보건", "중대재해", "직업병",
    # 노조
    "노조", "노동조합", "단체교섭", "부당노동행위", "파업", "쟁의",
    # 고용보험·사회보험
    "고용보험", "실업급여", "4대보험",
    # 법·기관
    "근로기준법", "노동법", "노동위원회", "고용노동부", "근로감독관",
    "노동청", "고용부", "근기법",
    # 일반 직장 상황어
    "직장", "회사", "사업주", "사용자", "고용주", "사장", "상사",
    "알바", "아르바이트", "파트타임", "계약직", "정규직", "비정규직",
    "재직", "근무", "출근", "퇴근", "일하다", "일했",
    "남녀고용평등",
])

# 비노동법 확정 키워드 (포함 시 off-topic 판단을 강화)
_NON_LABOR_KEYWORDS: frozenset = frozenset([
    "날씨", "요리", "레시피", "맛집", "여행", "관광", "쇼핑", "패션",
    "주식", "코인", "암호화폐", "부동산", "투자", "재테크",
    "연예인", "드라마", "영화", "음악", "게임",
    "의료", "병원", "처방", "약", "다이어트",
    "형사", "민사", "이혼", "상속", "부동산등기", "교통사고",
    "수학", "과학", "역사", "지리", "영어번역",
])

# 노동법 관련 동사·표현 패턴 (단독으로 명확히 직장 상황을 나타냄)
_LABOR_PATTERN = _re.compile(
    r"못\s*받|안\s*줘|안\s*줬|받지\s*못|지급\s*안|지급하지\s*않|"
    r"해고|짤렸|잘렸|그만두|나가라|나오지\s*마|나오지\s*말|"
    r"야근|초과\s*근무|연장\s*근무|"
    r"근로\s*계약|계약\s*기간|계약이\s*만료|"
    r"연차\s*못|휴가\s*못|"
    r"일하는데|일하고\s*있|근무하는데|"
    r"노동\s*위원|고용\s*노동|근로\s*감독",
    _re.IGNORECASE,
)


def is_labor_law_related_fast(text: str) -> Tuple[bool, str]:
    """
    LLM 없이 키워드·패턴 기반으로 노동법 관련 여부를 빠르게 판단.

    Returns:
        (is_related: bool, reason: str)
        - True  → 노동법 관련 (proceed normally)
        - False → 비노동법 (show guidance message)
        reason은 디버그용 짧은 설명.
    """
    if not text or not text.strip():
        return True, "empty_text"

    text_normalized = text.strip()

    # 1) 노동법 키워드 직접 포함 확인
    for kw in _LABOR_POS_KEYWORDS:
        if kw in text_normalized:
            return True, f"keyword:{kw}"

    # 2) 노동법 관련 동사 패턴 확인
    if _LABOR_PATTERN.search(text_normalized):
        return True, "pattern_match"

    # 3) 비노동법 키워드가 있으면 off-topic 판단
    for kw in _NON_LABOR_KEYWORDS:
        if kw in text_normalized:
            return False, f"non_labor_keyword:{kw}"

    # 4) 판단 불확실 → 보수적으로 True 반환 (LLM이 처리하도록 위임)
    return True, "uncertain_default_true"
